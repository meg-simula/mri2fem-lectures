% For compatibility with acroread version 
\pdfminorversion=4

\documentclass[mathserif, aspectratio=169]{beamer}
\mode<presentation>

%\usefonttheme[onlymath]{serif}
\usepackage[T1]{fontenc}
%\usepackage{tgheros}
%\usepackage{tgadventor}
%\usepackage{libertine}
%\usepackage{theinhart}
%\usepackage{palatino}
%\usepackage{newtxtext} %Times font only for text

% Use my theme
\usetheme{rognes}

% Used for image placement
\def\imagetop#1{\vtop{\null\hbox{#1}}}

% Misc packages
\usepackage{graphicx}
\usepackage[export]{adjustbox}
\usepackage{stmaryrd}
\usepackage{tikz}
\usepackage{booktabs}
\usepackage{multirow}
\usetikzlibrary{arrows,shapes,backgrounds,decorations,mindmap,patterns,snakes}
\usepackage{amsmath, amssymb, amsthm, amscd}
\usepackage[english]{babel}
\usepackage{algorithm}
\usepackage{pythonhighlight}
\usepackage{epstopdf}
\usepackage{multimedia}
\usepackage{soul}

\newcommand{\R}{\mathbb{R}}
\DeclareMathOperator{\Div}{\mathrm{div}}
\DeclareMathOperator{\Curl}{\mathrm{curl}}
\DeclareMathOperator{\Grad}{\mathrm{grad}}
\DeclareMathOperator{\D}{d}
\newcommand{\foralls}{\forall \;}
\newcommand{\iinner}[2]{\llangle #1, #2 \rrangle}
\newcommand{\inner}[2]{\langle #1,  #2\rangle}
\newcommand{\totald}{\mathrm{d}}
\newcommand{\refer}[1]{\begin{flushright}{\tiny \textcolor{darkgray}{[#1]}}\end{flushright}}
\newcommand{\referinline}[1]{{\tiny \textcolor{darkgray}{[#1]}}}
\newcommand{\ddt}[1]{{#1}_t}
\newcommand{\Mi}{M_i}
\newcommand{\Me}{M_e}
\newcommand{\Iion}{I_{\rm{ion}}}
\newcommand{\dx}{\, \mathrm{d}x}
\newcommand{\ds}{\, \mathrm{d} s}
\newcommand{\triang}{\mathcal{T}}
\DeclareMathOperator{\trace}{tr}
\newcommand{\duality}[2]{\langle #1, #2 \rangle}

\newcommand{\mysection}[1]{\begin{frame} \begin{center} \vspace{3em} \textbf{#1} \end{center} \end{frame}}
\newcommand{\videosection}[2]{\begin{frame} \begin{center} \vspace{3em} \href{#2}{\textcolor{rognesred}{\textbf{#1}}} \end{center} \end{frame}}
\newcommand{\sectionwithrefer}[2]{\begin{frame} \begin{center} \vspace{3em} \textbf{#1} \end{center} \refer{#2} \end{frame}}

\newtheorem{prop}[theorem]{Proposition}


\tikzstyle{na} = [baseline=-.5ex]
\tikzstyle{every picture}+=[remember picture]
\everymath{\displaystyle}

\usepackage[small, figurename=,size=scriptsize,font={color=darkgray}]{caption}



%% \usepackage{listings}
%% \usepackage[most]{tcolorbox} 	%used for writing process notes, code boxes 
%% \tcbuselibrary{listings,skins}  % skins needed for code box styles
%% \usepackage{color}
%% \usepackage{amsfonts}
%% \usepackage{fancyvrb}		%provides tab and white space preservation for 
%% 				%the verbatim environment. Needed for Python
%% 				%code inclusion

\definecolor{programcode}{gray}{0.65}

\def\formtmpX#1#2{{\vskip3pt\noindent\fboxsep=0pt{\parbox{\textwidth}{\hbox to \textwidth{\hskip3pt\vbox{\raggedright\noindent\textbf{#2\vphantom{Qy}}}\hfill}}}\vskip3pt\par
\noindent\kern0pt}}

\newenvironment{programcode}[1]{\ignorespaces\def\stmtopen##1{##1}%
\formtmpX{programcode}{\centerline{\small{#1}}}}{\noindent\textcolor{programcode}{\rule{\columnwidth}{0pt}}\par\addvspace{\baselineskip}}%



\newcommand{\terminal}[1]{
  \vspace{-1em}
  \begin{programcode}{}%{Terminal window}%
    \colorbox{blue!10}{\parbox{0.98\textwidth}{\textcolor{black}{\texttt{#1}}}}
  \end{programcode}
  \vspace{-0.5em}
}

\newcommand{\emp}[1]{\texttt{#1}}

%-------------------------------------------------------------------------------
%-------------------------------------------------------------------------------

\DeclareMathOperator{\ssum}{\textstyle \sum}

\begin{document}

%-------------------------------------------------------------------------------
\cleanpage
\begin{frame}
  \begin{columns}
    \begin{column}{0.25\textwidth}
    \centering
    \vspace{1em}
    \includegraphics[width=\textwidth]{graphics/simula_logo_main_RGB.pdf} \\
    \vspace{1em}
    \includegraphics[width=\textwidth]{graphics/waterscales.pdf}  \\
    \vspace{1em}
    \includegraphics[height=0.3\textwidth]{graphics/flag_yellow_low.jpg} 
    \hspace{0.2em}
    \includegraphics[width=0.3\textwidth]{graphics/logo-erc.jpg} \\
    \vspace{1em}
    \includegraphics[width=0.5\textwidth]{graphics/waterscape_logo.png} \\
    \vspace{1em}
    \includegraphics[width=\textwidth]{graphics/rcn-logo.pdf} \\
    \end{column}
    \begin{column}{0.75\textwidth}
    {
    \centering

      \vspace{4em}

      {\bf Brain modelling: \\ from magnetic resonance images \\ to finite element simulation} \\

      \bigskip
      \bigskip
      
      Marie E. Rognes \\
      \bigskip
      \bigskip

      Oslo, Norway \\
      \medskip
      Feb 11 2020 \\
      }
    \end{column}
  \end{columns}
\end{frame}

\cleanpage

% ---------------------------------------------------------------------------------------
\input{/home/meg/presentations/slides/waterscape_uq_tracer_2019.tex}

% 5 min
% ---------------------------------------------------------------------------------------

\begin{frame}
  \frametitle{Outline of lectures}
  \begin{center}
  \includegraphics[height=2.3cm]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp1/FIG/T1-image-rot-white}
  \includegraphics[height=2.3cm]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp1/FIG/ernie-volume-64}
  \includegraphics[height=2.3cm]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp1/FIG/soltn-t30-crop}
  \end{center}
  \begin{description}
    \item[Lecture 1-2] Quick start: From brain MRI to FEM
      \begin{itemize}
      \item
        Why simulate the brain's waterscape?
      \item
        Where can I find the slides (and book, data, and scripts)?
      \item
        Introduction to brain physiology and imaging
        %% \begin{enumerate}{\roman}
        %% \item
        %%   Introduction to the brain's waterscape: anatomy
        %% \item
        %%   Introduction to the brain's waterscape: mechanics
        %% \item
        %%   Introduction to brain imaging (MRI)
        %% \item
        %%   A software ecosystem: from MRI to finite elements
        %% \end{enumerate}
      \item
        From T1 MRI images to numerical simulation
        %% \begin{itemize}
        %% \item
        %%   A model problem: diffusion of solutes
        %% \item
        %%   From T1 images to a finite element mesh
        %% \item
        %%   A numerical simulation of diffusion
        %% \end{itemize}
      \end{itemize}
    \item[Lecture 3-4] Meshing hemispheres, brains, ventricles, parcellations
    \item[Lecture 5-6] Introducing anisotropy and heterogeneities (DTI)
  \end{description}
\end{frame}

{\usebackgroundtemplate{\includegraphics[width=\paperwidth]{graphics/Collaborators.pdf}}
\begin{frame}
\end{frame}
}

\mysection{Lecture series resources}

\begin{frame}
  \frametitle{These slides and other lecture material are openly available via GitHub}
  \centering
  \includegraphics[width=\textwidth]{graphics/mri2fem-lectures-github.png} \\
  \refer{\href{https://github.com/meg-simula/mri2fem-lectures}{https://github.com/meg-simula/mri2fem-lectures}}
\end{frame}

\begin{frame}
  \frametitle{Mathematical modeling of the human brain -- book available on GitHub}
  \framesubtitle{by KA Mardal, ME Rognes, TB Thompson and LM Valnes; Simula SpringerBrief on Computing (2021)}
  \centering
  \includegraphics[width=\textwidth]{graphics/mri2fem-book-github.png} \\
  \refer{Mardal et al (2021): \href{https://github.com/kent-and/mri2fem}{https://github.com/kent-and/mri2fem}}
\end{frame}


\begin{frame}
  \frametitle{Resources (data, software) are openly available with our Zenodo community}
  \vspace{-0.5em}
  \centering
  \includegraphics[width=0.85\textwidth]{graphics/mri2fem-zenodo.png} \\
  \vspace{-1em}
  \refer{\href{https://zenodo.org/communities/mri2fem/}{https://zenodo.org/communities/mri2fem/}}
\end{frame}

% 10 min
% ---------------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
%
% Lecture 1
% \input{lecture1.tex}
%
%-------------------------------------------------------------------------------

\mysection{The brain's waterscape: anatomy}

\input{/home/meg/presentations/slides/waterscape_anatomy.tex}

\begin{frame}
  \frametitle{Brain vasculature and paravascular spaces}
  \vspace{-1em}
  \begin{columns}[c]
      \begin{column}{0.4\textwidth}
      \begin{center}
        \includegraphics[width=0.9\textwidth]{graphics/uludag_et_al_2018_fig2.jpg} \\
        \includegraphics[width=0.9\textwidth]{graphics/mestre_mori_nedergaard_2020_fig2.jpg}
      \end{center}
      \end{column}
      \begin{column}{0.6\textwidth}
      \begin{center}
        \includegraphics[width=0.95\textwidth]{graphics/kaufmanfrancis_et_al_2018_fig1.jpg}
      \end{center}
      \end{column}
  \end{columns}
  \refer{\href{https://doi.org/10.1016/j.neuroimage.2017.02.063}{Uludag et al (2018) (Fig.~2)}; \href{https://doi.org/10.1016/j.tins.2020.04.003}{Mestre, Mori and Nedergaard (2020) (Fig.~2)}; \href{https://doi.org/10.1016/j.ajpath.2018.03.015}{Kaufman-Francis et al (2018) (Fig.~1)}}
\end{frame}

\begin{frame}
  \frametitle{Brain anatomy at the cellular level}
  \vspace{-2em}
  \begin{columns}[t]
      \begin{column}{0.6\textwidth}
      \begin{center}
        \includegraphics[width=0.8\textwidth]{graphics/cells_illustration.png}
      \end{center}
      \end{column}
      \begin{column}{0.4\textwidth}
      \begin{center}
        \includegraphics[width=\textwidth]{/home/meg/presentations/slides/graphics/holter2017Fig1.png}
      \end{center}
      \end{column}
  \end{columns}
  \refer{\href{http://sm.stanford.edu/archive/stanmed/2009fall/article6.html}{Stanford Medicine (2009)};
    \href{https://doi.org/10.1073/pnas.1706942114}{Holter et al (2017) (Fig~1)}}
 \end{frame}


\mysection{The brain's waterscape: physiology}

\input{/home/meg/presentations/slides/waterscapes_lymphatics_short.tex}

\input{/home/meg/presentations/slides/waterscape_diffusion.tex}

{\usebackgroundtemplate{\hspace{1em} \includegraphics[width=0.95\paperwidth]{graphics/glymphatic.jpg}}
\begin{frame}
  \vspace{1em}
  The glymphatic pathway is a \\ brain fluid-clearance pathway theory
  \vspace{18em}
  \refer{\href{https://stm.sciencemag.org/content/4/147/147ra111.full}{Iliff et al (2012)}; \href{https://doi.org/10.1016/S1474-4422(18)30318-1}{Rasmussen et al (2018) (Fig.~1)}}
\end{frame}
}

\begin{frame}
  \begin{center}
    \includegraphics[width=\textwidth]{graphics/abbott_2018.png}
  \end{center}
\end{frame}

\input{/home/meg/presentations/slides/amyloid_tau.tex}
%\input{/home/meg/presentations/slides/waterscape_dementia_aggregations.tex}

\input{/home/meg/presentations/slides/waterscape_sleep_xie.tex}
\input{/home/meg/presentations/slides/waterscapes_alzheimers.tex}

%% \begin{frame}
%%   \frametitle{Alcohol}
%% \end{frame}

%% \begin{frame}
%%   \frametitle{Exercise}
%% \end{frame}

\mysection{A very brief introduction to magnetic resonance imaging (MRI)}

\begin{frame}
  \frametitle{T1-weighted MRI reveals brain structure}
  \begin{center}
  \includegraphics[height=0.52\textheight]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp2/FIG/T1-image.png}
  \includegraphics[height=0.52\textheight]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp2/FIG/exp-brain.png}
  \includegraphics[height=0.52\textheight]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp2/FIG/exp-matters.png}
  \end{center}
  %% \caption{MR images (T1) of the human brain. Left: A sagittal
  %%   (longitudinal) cross-section of the human brain with the cerebrum
  %%   in blue, the cerebellum in red, and brain stem in yellow. Right: A
  %%   coronal (frontal) section of the brain. The tissue matter
  %%   composition of the cerebrum has been marked by color: red marking
  %%   the cortical gray matter, blue marking the subcortical gray matter
  %%   and white marking the white matter. (The colors have been added in
  %% post-processing.)}

  Axial, sagittal and coronal cross-sections. T1 MRI: fat gives high
  signal intensity (light/white); fluids give low signal intensity
  (dark/black).
\end{frame}

\begin{frame}
  \frametitle{T2-weighted MRI reveals brain structure and fluids}
\begin{figure}
  \centering
  \includegraphics[height=0.7\textheight]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp2/FIG/T1-image.png}
  \hspace{2em}
  \includegraphics[height=0.7\textheight]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp2/FIG/T2-image.png}
  %% \caption{T1 weighted image (left) versus T2 weighted image (right).
  %%   In the T1 weighted image, white matter is recognized in the light
  %%   gray color, whereas the darker gray color that surface the brain
  %%   is gray matter. T1 weighted images is used in particular as it has
  %%   a sharp contrast between gray and white matter.  The T2 weighted
  %%   images shows the CSF as almost white and provides good contrast
  %%   between the CSF and the brain, but less contrast between white and
  %%   gray matter.}
\end{figure}
T1 (left) versus T2 (right). In T2 MRI: fluids gives high signal intensity (light/white)
\end{frame}

\begin{frame}
  \frametitle{Diffusion-tensor MRI reveals water movement and directionality}
  \begin{center}
  \includegraphics[width=0.4\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp2/FIG/DTI-slice-image-crop.png}
  \hspace{2em}
  \includegraphics[width=0.4\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp5/FIG/fiber-fa-2.png}
  \end{center}
  In DTI: high signal intensity indicates high degree of anisotropy 
\end{frame}

\begin{frame}
  \frametitle{Viewing and working with MRI data sets in DICOM format}

  Medical images are often stored in the DICOM file format: a
  collection of image files arranged in sequences. A DICOM viewer is
  essential for working with DICOM files.

  \bigskip
  
  Many possibilities including \href{https://wiki.xnat.org/xnat-tools/dicombrowser}{DicomBrowser}

  \bigskip
  
  \terminal{\$ sudo apt-get install dicombrowser \hfill(my Ubuntu 18.04)\\
  \$ DicomBrowser \&}
\end{frame}

\videosection{Video example: downloading and viewing the MRI2FEM DICOM data set}{http://zenodo.org}

\mysection{A software ecosystem: from MRI to finite elements}

\begin{frame}
\frametitle{Illustration of pipeline}

  \begin{center}
  \includegraphics[height=2.3cm]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp1/FIG/T1-image-rot-white}
  \includegraphics[height=2.3cm]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp1/FIG/ernie-volume-64}
  \includegraphics[height=2.3cm]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp1/FIG/soltn-t30-crop}
  \end{center}

\end{frame}

\begin{frame}
\frametitle{Recommended software components}

\begin{itemize}
\item
  Python3 for everything
\item
  FreeSurfer for segmentation: \href{https://surfer.nmr.mgh.harvard.edu/}{https://surfer.nmr.mgh.harvard.edu/}
\item
  NiBabel for image manipulations: \href{https://nipy.org/nibabel/}{https://nipy.org/nibabel/}
\item
  SVM-Tk for meshing: \href{https://github.com/SVMTK/SVMTK}{https://github.com/SVMTK/SVMTK}
\item
  meshio for mesh conversions: \href{https://github.com/nschloe/meshio}{https://github.com/nschloe/meshio}
\item
  FEniCS for finite elements : \href{https://fenicsproject.org/}{https://fenicsproject.org/}
\item
  ParaView for visualization: \href{https://www.paraview.org/}{https://www.paraview.org/}
\end{itemize}

\end{frame}

%-------------------------------------------------------------------------------
%
% Lecture 2
% \input{lecture2.tex}
%
%-------------------------------------------------------------------------------

\mysection{A model problem: diffusion of solutes}

\begin{frame}
  \frametitle{Aim: to model and simulate the diffusion of a solute in brain regions}
  \vspace{-5em}
  \begin{block}{Model problem: diffusion equation}
    Find the concentration $u = u(t, x)$ at spatial points $x \in
    \Omega$ and time points $t > 0$ such that
    \begin{subequations}
      \label{eq:diffusion}
      \begin{align}
        \label{eq:diffusion:a}
        u_t - \Div D \Grad u &= f &&\text{ in } (0, T] \times \Omega, \\
          \label{eq:diffusion:b}
          u &= u_d && \text{ on } (0, T] \times \partial \Omega, \\
            \label{eq:diffusion:c}
            u(0, \cdot) &= u_0 && \text{ in } \Omega.
      \end{align}
    \end{subequations}
  \end{block}

\end{frame}

\mysection{From T1 images to a finite element mesh}

\begin{frame}
\frametitle{Follow these three steps to generate a mesh from T1 images}

To generate a mesh from an MRI data set including T1-weighted images,
we follow three main steps:
\bigskip
\begin{enumerate}
\item
  extract a T1-weighted image series from the MRI dataset using DicomBrowser;
\item
  create (boundary) surfaces from the T1-weighted images using FreeSurfer;
\item
  generate a volume mesh of the interior using FreeSurfer along with SVM-Tk.
\end{enumerate}
\end{frame}

\videosection{Video example: extracting MR series using DicomBrowser}{}

\begin{frame}
\frametitle{Step 2: Using FreeSurfer to segment images and create surfaces}

FreeSurfer offers the command \emp{recon-all} to segment the brain images
and reconstruct surfaces. 

\terminal{\$ cd mri2fem-dataset \\
\$ cd dicom/ernie/T13D \\
\$ recon-all -subjid ernie -i IM\_0162 -all}

This command is compute-intensive, with run times likely of 12--24
hours.

Key outputs (\emp{mri2fem-dataset/freesurfer/ernie}). are 
\begin{itemize}
\item \emp{/stats}: contains files providing statistics derived during segmentation.
\item \emp{/mri}: contains volume files generated during segmentation
\item \emp{/surf}: contains surface files generated during segmentation
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{FreeSurfer generates pial and white/gray matter surfaces}

\terminal{\$ cd mri2fem-dataset/freesurfer/ernie/surf\\
\$ mris\_convert ./lh.pial pial.stl \\
\$ paraview}

\end{frame}

\videosection{Video example: viewing the FreeSurfer output}{}

\begin{frame}
\frametitle{The surfaces may need enhancement to be suitable for finite element meshes}

\begin{columns}
\begin{column}{0.6\textwidth}
In practice, brain surfaces generated from T1 images 
\vspace{-1em}
\begin{itemize}
\item may have unphysiologically sharp corners,   
\item may include triangles with very large aspect ratios, 
\item have topological defects such as holes, and
\item may self-intersect or overlap with other surfaces.   
\end{itemize}

\medskip

\alert{Result:} Low quality meshes (if any). \\

\medskip

\alert{Fix:} Enhance surface quality prior to meshing
\end{column}
\begin{column}{0.4\textwidth}
  \centering
  \includegraphics[width=\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/juncturers-gap.png}
\end{column}

\end{columns}
\end{frame}


\begin{frame}
  \frametitle{SVM-Tk includes utilities for remeshing surfaces}
  \centering
  \includegraphics[width=0.49\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/raw-stlmesh.png}
  \includegraphics[width=0.49\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/remesh-stlmesh.png}
  %\caption{Original (left) pial surface and (right) after remeshing with \svmtk{}}
  \refer{Mardal et al (2021, Chapter 3.2.1); mri2fem/chp3/remesh\_surface.py}
\end{frame}


\begin{frame}
  \frametitle{SVM-Tk includes utilities for smoothing surfaces}
  \begin{figure}
  \centering
  \includegraphics[width=0.32\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/unsmoothed.png}
  \includegraphics[width=0.32\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/taubin-smoothed-10.png}
  \includegraphics[width=0.32\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/oversmoothing.png}

  Original pial surface \hspace{3em} after Taubin smoothing \hspace{3em}
after over-smoothing.
  \end{figure}
  \bigskip
  
  \refer{Mardal et al (2021, Chapter 3.2.2); mri2fem/chp3/smooth\_surface.py}
\end{frame}

\begin{frame}[fragile]
\frametitle{SVM-Tk is designed to create brain volume meshes from surfaces}

\begin{columns}
\begin{column}{0.34\textwidth}
\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/ernie-volume-16-r.png} \\
  \includegraphics[width=\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/ernie-volume-64-r.png}
\end{figure}
\end{column}
\begin{column}{0.65\textwidth}
  \begin{python}
import SVMTK as svmtk

def create_volume_mesh(stlfile, output, n=16):
    # Load input file
    surface = svmtk.Surface(stlfile)
    
    # Generate the volume mesh
    domain = svmtk.Domain(surface)
    domain.create_mesh(n)

    # Write the mesh to the output file
    domain.save(output)

# Create mesh    
create_volume_mesh("lh.pial.stl", "lh.mesh")
  \end{python}
  \refer{Mardal et al (2021, Chapter 3.1.3); mri2fem/chp3/surface\_to\_mesh.py}
\end{column}
\end{columns}

\end{frame}

\videosection{Video example: creating a mesh of the left hemisphere}{}

\mysection{A numerical simulation of diffusion}

\begin{frame}
\frametitle{Solving the diffusion equation with implicit Euler and finite elements (I)}

Recall our diffusion equation:
\begin{equation*}
  u_t - \Div D \Grad u = f \text{ in } (0, T] \times \Omega, 
\end{equation*}

Define discrete times: 

%% $0 = t_0 \leq t_1 \dots \leq t_N = T$, where $N$ is the number of time
%% steps and the time step (size) $\tau_n = t_n - t_{n-1}$ for $n = 1,
%% \dots, N$.

\bigskip
\bigskip

Compute approximate solutions $u^n_h$ of~\eqref{eq:diffusion} such
that $u^n_h \approx u(t^n)$ for each $n$.

\medskip
We do a first-order backward difference approximation in time
%% \begin{equation}
%%   u(t_n) \approx u^n, \quad
%%   u_t(t_n) \approx \frac{1}{\tau_n} (u^n - u^{n-1}),
%% \end{equation}

\bigskip
\bigskip

and obtain:
\begin{equation}
  \label{eq:chp3:time-discrete}
  \frac{1}{\tau_n} (u^n - u^{n-1}) - \Div D \Grad u^n = f(t^n) \quad \text{in } \Omega. 
\end{equation}

\end{frame}


\begin{frame}
  \frametitle{Solving the diffusion equation with implicit Euler and finite elements (II)}

  \begin{equation*}
    \frac{1}{\tau_n} (u^n - u^{n-1}) - \Div D \Grad u^n = f(t^n) \quad \text{in } \Omega. 
  \end{equation*}

  Let $V_h$ be continuous piecewise $k$-polynomials relative to
  our mesh defining $\Omega$.

  \bigskip
  Derive weak formulation: 
  \vspace{10em}
  
\end{frame}


\begin{frame}
  \frametitle{Solving the diffusion equation with implicit Euler and finite elements (II)}

  Let $V_h$ be continuous piecewise $k$-polynomials relative to
  our mesh defining $\Omega$.

  \bigskip

  Multiply by test functions $\phi \in V_h$, integrate by parts, and
  shuffle to obtain the weak formulation:

  \bigskip
  
  Find the discrete solution $u_h^n \in V$ at each time $n = 1, \dots,
  N$ such that
  \begin{equation*}
    \inner{u_h^n}{\phi} + \tau_n \inner{\Grad u_h^n}{\Grad \phi}
    =  \inner{u_h^{n-1}}{\phi} + \tau_n \inner{f^n}{\phi},  
  \end{equation*}
  for all $\phi \in V_h$.
  
  \bigskip
  
  where
  \begin{equation*}
    \inner{u}{\phi} = \int_{\Omega} u \, \phi \dx.
  \end{equation*}
    \refer{The FEniCS tutorial (2016); Mardal et al (2021, Chapter 3.3.3); mri2fem/chp3/diffusion.py}
\end{frame}

\begin{frame}[fragile]
\frametitle{Solving the diffusion equation using FEniCS}

  \begin{python}
# Read the mesh
mesh = Mesh()
file = XDMFFile(MPI.comm_world, "ernie.xdmf") # mm 
file.read(mesh)
...
# Define the finite element spaces and functions
V = FunctionSpace(mesh, "Lagrange", 1)
u = TrialFunction(V)
...
# Define the variational system to be solved at each time
a = (u*v + tau*D*dot(grad(u), grad(v)))*dx
L = (u_*v + tau*f*v)*dx
...
# Solve at each time step
for n in range(1, N+1):
    ...
    bc.apply(A, b)
    solve(A, u.vector(), b, "gmres", "amg")
  \end{python}
  \vspace{-1em}
  \refer{The FEniCS tutorial (2016); Mardal et al (2021, Chapter 3.3.3); mri2fem/chp3/diffusion.py}

\end{frame}

\begin{frame}
\frametitle{Simulated tracer concentrations after injection into the SAS}

\begin{columns}[T]
  \begin{column}{0.6\textwidth}
    \begin{figure}
      \begin{tabular}{l l l l}
        \imagetop{2h}&  \imagetop{\includegraphics[width=0.35\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/mri-tracer/2h}}&
        \imagetop{6h}&  \imagetop{\includegraphics[width=0.35\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/mri-tracer/6h}}\\
        \imagetop{12h}& \imagetop{\includegraphics[width=0.35\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/mri-tracer/12h}}&
        \imagetop{24h}& \imagetop{\includegraphics[width=0.35\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/mri-tracer/24h}}\\
        \imagetop{48h}& \imagetop{\includegraphics[width=0.35\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/mri-tracer/48h}}&
        \imagetop{72h}& \imagetop{\includegraphics[width=0.35\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/mri-tracer/72h}}
      \end{tabular}
      %% \caption{Simulated tracer concentration at given times (2, 6, 12,
      %%   24, 48, 72h) post injection into subarachnoid CSF. Blue
      %%   represents lower values, while yellow represents higher values.}
    \end{figure}
  \end{column}
  \begin{column}{0.4\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/amounts.png} \\
    \includegraphics[width=0.9\textwidth]{/home/meg/papers/current/hikeandsurf/Book/chapters/chp3/FIG/concentrations.png}
    %    \caption{Plots of quantities of interest associated with the
    %  computed concentration solution: total amount of solute $Q$ over
    %  time $t$ (left) and concentration of solution $u(p, t)$ for a
    %  given point $p$ over time $t$ (right).}
    %\label{fig:chp3:png-plots}
  \end{column}
\end{columns}

\end{frame}

\videosection{Video example: simulating diffusion}{}


\mysection{Until next week ...}
 
\begin{frame}
\frametitle{Want to give it a try? Natural first steps:}
\begin{enumerate}
\item
  Download the slides from this lecture:  \href{https://github.com/meg-simula/mri2fem-lectures}{https://github.com/meg-simula/mri2fem-lectures}.
\item
  Download the MRI2FEM data set and software from Zenodo and inspect
  the contents using the tools discussed.
\item
  Download the book: Mardal et al (2021): \href{https://github.com/kent-and/mri2fem}{https://github.com/kent-and/mri2fem}.
\item
  Install software dependencies following the instructions in Chapter
  2 of Mardal et al (2021).
\item
  Try running some of the sample code in Chapter 3 of Mardal et al
  (2021).
\end{enumerate}
\end{frame}

%-------------------------------------------------------------------------------


\end{document}
